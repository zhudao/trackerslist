name: â¬†ï¸ Upstream Fork Sync

permissions:
  contents: write

on:
  schedule:
    - cron: "0 2 * * *"  # æ¯å¤© UTC+0 02:00ï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰è‡ªåŠ¨åŒæ­¥
  workflow_dispatch:
    inputs:
      sync_test_mode:
        description: 'æ˜¯å¦å¯ç”¨æµ‹è¯•æ¨¡å¼ï¼ˆä»…æ¨¡æ‹ŸåŒæ­¥ï¼Œä¸æ¨é€ï¼‰'
        type: boolean
        default: false

env:
  DEFAULT_SYNC_BRANCH: master                     # é»˜è®¤åˆ†æ”¯ï¼ˆå¯é€šè¿‡ secret è¦†ç›–ï¼‰


  UPSTREAM_SYNC_REPO: ngosang/trackerslist   # âœ… ä¸Šæ¸¸ä»“åº“ï¼ˆæå–ä¸ºå…¨å±€å˜é‡ï¼‰


  UPSTREAM_SYNC_BRANCH: master                      # ä¸Šæ¸¸åˆ†æ”¯



jobs:
  sync-upstream:
    name: ğŸ”„ åŒæ­¥ä¸Šæ¸¸ä»“åº“
    if: ${{ github.event.repository.fork }}
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ åˆå§‹åŒ–ä»“åº“ä¿¡æ¯
        id: repo-info
        run: |
          echo "å½“å‰ä»“åº“åï¼š${{ github.repository }}"
          echo "é»˜è®¤åˆ†æ”¯ä¸ºï¼š${{ secrets.MY_TARGET_SYNC_BRANCH || env.DEFAULT_SYNC_BRANCH }}"
          echo "ä¸Šæ¸¸æºä¸ºï¼š${{ env.UPSTREAM_SYNC_REPO }}@${{ env.UPSTREAM_SYNC_BRANCH }}"
          echo "æ˜¯å¦ä¸ºæµ‹è¯•æ¨¡å¼ï¼š${{ inputs.sync_test_mode }}"
          echo "SYNC_BRANCH=${{ secrets.MY_TARGET_SYNC_BRANCH || env.DEFAULT_SYNC_BRANCH }}" >> "$GITHUB_ENV"

      - name: ğŸ“¥ æ£€å‡ºå½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          ref: ${{ secrets.MY_TARGET_SYNC_BRANCH || env.DEFAULT_SYNC_BRANCH }}
          persist-credentials: false

      - name: ğŸ” æ‰§è¡ŒåŒæ­¥
        id: sync
        uses: aormsby/Fork-Sync-With-Upstream-action@v3.4.1
        with:
          target_sync_branch: ${{ secrets.MY_TARGET_SYNC_BRANCH || env.DEFAULT_SYNC_BRANCH }}
          upstream_sync_repo: ${{ env.UPSTREAM_SYNC_REPO }}         # âœ… ä½¿ç”¨ç»Ÿä¸€å˜é‡
          upstream_sync_branch: ${{ env.UPSTREAM_SYNC_BRANCH }}     # âœ… ä½¿ç”¨ç»Ÿä¸€å˜é‡
          target_repo_token: ${{ secrets.GITHUB_TOKEN }}
          test_mode: ${{ github.event_name == 'workflow_dispatch' && inputs.sync_test_mode || false }}

      - name: âœ… æ˜¾ç¤ºåŒæ­¥ç»“æœ
        run: |
          if [[ "${{ steps.sync.outputs.has_new_commits }}" == "true" ]]; then
            echo "âœ… å·²åŒæ­¥ï¼Œæœ‰æ–°æäº¤å·²åˆå¹¶è‡³ ${{ env.SYNC_BRANCH }}"
          else
            echo "â„¹ï¸ æ— éœ€åŒæ­¥ï¼Œä¸Šæ¸¸æ²¡æœ‰æ–°æäº¤ã€‚"
          fi

      - name: ğŸš¨ åŒæ­¥å¤±è´¥å¤„ç†
        if: failure()
        run: |
          echo "âŒ åŒæ­¥å¤±è´¥ï¼Œå¯èƒ½åŸå› å¦‚ä¸‹ï¼š"
          echo "- GitHub Actions å›  workflow æ–‡ä»¶è¢«ä¿®æ”¹è€Œæš‚åœè¿è¡Œ"
          echo "- GITHUB_TOKEN æƒé™å¤±æ•ˆæˆ– fork ä»“åº“æ— å†™æƒé™"
          echo "- ä¸Šæ¸¸ä»“åº“ä¸å¯è¾¾ï¼Œæˆ–ç½‘ç»œé”™è¯¯"
          echo "ğŸ”§ å»ºè®®ï¼šæ‰‹åŠ¨æ‰§è¡Œ Sync Fork æˆ–æ£€æŸ¥ Actions çŠ¶æ€é¡µ"
          echo "ğŸ‘‰ å‚è€ƒï¼šhttps://docs.github.com/en/actions/monitoring-and-troubleshooting-workflows"

      # ğŸ“¨ å¯é€‰é€šçŸ¥
      # - name: ğŸ“¬ Notify via webhook
      #   if: steps.sync.outputs.has_new_commits == 'true'
      #   run: |
      #     curl -X POST -H "Content-Type: application/json" \
      #     -d '{"msg": "åŒæ­¥æˆåŠŸï¼šæœ‰æ–°æäº¤ï¼"}' https://your-notification-endpoint
